server {
    listen ${PORT};
    server_name localhost;
    root /splitiv/apps/web/dist;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), camera=(), microphone=()" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    # If you don't need SharedArrayBuffer, remove the next header
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:" always;

    # Compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    # If serving precompressed assets
    # gzip_static on;
    etag on;

    # Ensure correct MIME type for the web manifest
    include /etc/nginx/mime.types;
    types {
        application/manifest+json  webmanifest;
    }

    # All assets contain hash in filename, cache aggressively
    location ^~ /assets/ {
        add_header Cache-Control "public, max-age=31536000, s-maxage=31536000, immutable";
        try_files $uri =404;
    }

    # Workbox scripts are hashed, cache aggressively
    location ^~ /workbox- {
        add_header Cache-Control "public, max-age=31536000, s-maxage=31536000, immutable";
        try_files $uri =404;
    }

    # Service worker should never be cached
    location = /sw.js {
        add_header Cache-Control "public, max-age=0, s-maxage=0, must-revalidate" always;
        expires off;
        try_files $uri =404;
    }

    # Vite PWA register file should not be cached
    location = /registerSW.js {
        add_header Cache-Control "public, max-age=0, s-maxage=0, must-revalidate" always;
        expires off;
        try_files $uri =404;
    }

    # Custom push handler used by the service worker, avoid long caching
    location = /sw-push.js {
        add_header Cache-Control "public, max-age=0, s-maxage=0, must-revalidate" always;
        expires off;
        try_files $uri =404;
    }

    # Manifest should not be cached
    location = /manifest.webmanifest {
        add_header Cache-Control "public, max-age=0, s-maxage=0, must-revalidate" always;
        expires off;
        try_files $uri =404;
    }

    # HTML entry should not be cached
    location = /index.html {
        add_header Cache-Control "public, max-age=0, s-maxage=0, must-revalidate" always;
        expires off;
        try_files $uri =404;
    }

    # Cache common static root files (icons) for 7 days
    location ~* \.(?:png|ico)$ {
        add_header Cache-Control "public, max-age=604800" always;
        try_files $uri =404;
    }

    # Everything else is handled by the app router, inject index.html
    location / {
        autoindex off;
        expires off;
        add_header Cache-Control "public, max-age=0, s-maxage=0, must-revalidate" always;
        try_files $uri /index.html =404;
    }
}
